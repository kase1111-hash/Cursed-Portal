# AI Coding Instructions: Cursed Portal – Poe Parlor

## Project Overview

**Project Name:** Cursed Portal – Poe Parlor
**Engine:** Unity 2023.2 LTS (URP - Universal Render Pipeline)
**LLM Integration:** LLMUnity + local Ollama backend (Llama 3.x)
**Genre:** Gothic horror, interactive storytelling
**License:** MIT (Open Source) / Commercial License Available

---

## Step-by-Step Implementation Guide

### Phase 0: Project Setup (Do First)

#### 0.1 Create Unity Project
```
Unity Hub → New Project → 3D (URP) → Name: CursedPortal → Create
```

#### 0.2 Install Required Packages
| Package | Source | Action |
|---------|--------|--------|
| TextMeshPro | Unity Registry | Import TMP Essentials |
| Cinemachine | Unity Registry | Install |
| Universal RP | Pre-installed | Verify |
| LLMUnity | Git URL | Add: `https://github.com/undreamai/LLMUnity.git` |

#### 0.3 Set Up LLM Backend (Local)
1. Download llama.cpp server with Llama 3.2 3B GGUF model
2. Start server: `./server -m llama3.2-3b.gguf --host 0.0.0.0 --port 8080`
3. In Unity: Add LLM component (llama.cpp provider, base URL `http://localhost:8080`)

#### 0.4 Create Folder Structure
```
Assets/
├── Scenes/
│   ├── CursedPortal.unity
│   └── OtherDimension.unity
├── Scripts/
│   ├── Core/
│   ├── AI/
│   ├── AudioVFX/
│   ├── UI/
│   ├── Props/
│   └── Editor/
├── Prefabs/
│   ├── Managers/
│   └── Props/
├── PostFX/
│   └── Profiles/
├── StreamingAssets/
│   ├── PoeStories/
│   └── SpiritProfiles/
└── cursed_portal_build.yaml
```

#### 0.5 Download Poe Texts (Public Domain)
Save to `Assets/StreamingAssets/PoeStories/`:
| Spirit | Source | Save As |
|--------|--------|---------|
| Raven | https://www.gutenberg.org/ebooks/1065.txt.utf-8 | raven.txt |
| Usher | https://www.gutenberg.org/ebooks/932.txt.utf-8 | usher.txt |
| Tell-Tale Heart | https://www.gutenberg.org/files/2148/2148-0.txt | tell-tale-heart.txt |

---

### Phase 1: Core Systems (M1-M2)

#### 1.1 Create Scene: CursedPortal.unity

**Scene Hierarchy:**
```
CursedPortal (Empty Root)
├── PlayerRig (Capsule collider, Rigidbody)
│   └── Main Camera (Cinemachine POV)
│       Position: (0, 1.8, -8)
│       Rotation: (0, 0, 0)
│       FOV: 70°
├── RoomRoot (10x10x5m room)
│   ├── Floor
│   ├── Walls (4x)
│   ├── Table @ (0, 0.5, 0)
│   ├── CrystalBall @ (0, 1.2, 0)
│   ├── Booth @ (5, 0, 5)
│   └── Mirror @ (-5, 2, 5)
├── Managers (Empty - add scripts later)
├── Environment
│   ├── FogParticles (ParticleSystem)
│   └── GlobalVolume (URP Post-Processing)
└── UI
    ├── ChatCanvas
    └── DebugCanvas
```

**Lighting Setup:**
- DirectionalLight: Intensity 0.2, purple tint
- Point lights on props with candle flicker animation
- URP Global Volume: Fog density 0.01, Vignette 0.1, desaturated purple-blue

#### 1.2 Create Script: IInteractable.cs
**Location:** `Assets/Scripts/Core/IInteractable.cs`
```csharp
// Auto-generated by CursedPortal AI Spec v1.0
// Source: Module M2
public interface IInteractable {
    void OnInteract();
    void OnHighlightEnter();
    void OnHighlightExit();
}
```

#### 1.3 Create Script: InteractionManager.cs
**Location:** `Assets/Scripts/Core/InteractionManager.cs`
- Raycast from camera center (range: 3f)
- Detect IInteractable objects
- Press E to trigger OnInteract()
- Highlight targeted objects

---

### Phase 2: LLM & UI Systems (M3, M7, M9)

#### 2.1 Create Spirit Profiles JSON
**Location:** `Assets/StreamingAssets/SpiritProfiles/poe_spirits.json`
```json
{
  "Raven": {
    "story": "raven.txt",
    "prompt": "You are the Raven, forever croaking 'Nevermore'. Obsessed, despairing, rhythmic."
  },
  "Narrator": {
    "story": "tell-tale-heart.txt",
    "prompt": "You are the guilty Narrator from The Tell-Tale Heart, haunted by the beating heart."
  },
  "Usher": {
    "story": "usher.txt",
    "prompt": "You are Roderick Usher, decaying with your ancestral home, poetic dread."
  }
}
```

#### 2.2 Create Script: LLMManager.cs
**Location:** `Assets/Scripts/AI/LLMManager.cs`
- Singleton pattern with `Instance`
- `SummonSpirit(string spiritKey)` method
- Load story text from StreamingAssets
- Build context prompt with spirit personality
- Integrate with SpiritMemory for persistence

#### 2.3 Create Script: UIChat.cs
**Location:** `Assets/Scripts/UI/UIChat.cs`
- Singleton with `Instance`
- TMP_InputField for user input
- TMP_Text for chat log (ScrollView)
- Toggle visibility with ESC key
- Auto-scroll on new messages
- Show cursor when active

---

### Phase 3: Spook Escalation System (M4-M6)

#### 3.1 Create Script: EventManager.cs
**Location:** `Assets/Scripts/Core/EventManager.cs`
- Singleton pattern
- `spookLevel` property (0-5, clamped)
- `IncrementSpook(int delta)` method
- `ApplyEffectsForLevel(int level)` - triggers audio/VFX/PostFX
- Debounce logic (trigger each level only once)

**Spook Level Effects Table:**
| Level | Effect |
|-------|--------|
| 0 | Baseline ambience, faint whispers |
| 1 | Orb glow, slight vignette |
| 2 | Fog thickens, camera shake |
| 3 | Loud whispers, phantom silhouettes, chromatic aberration |
| 4 | Mirror glitch, lens distortion |
| 5 | Full fog, red tint, "DIMENSION BREACH", portal transition |

#### 3.2 Create Script: AudioManager.cs
**Location:** `Assets/Scripts/AudioVFX/AudioManager.cs`
- Singleton pattern
- AudioSources: ambientSource, sfxSource, voiceSource
- `AudioClip[] whispers` (indexed by spook level)
- `PlayWhispers(int level)`
- `PlaySFX(AudioClip clip, float pitch)`
- `UpdateAmbience(int level)` - adjust volume/pitch

#### 3.3 Create Script: VFXManager.cs
**Location:** `Assets/Scripts/AudioVFX/VFXManager.cs`
- Singleton pattern
- Control ParticleSystems: fogParticles, ghostPrefab, portalBurst
- `UpdateFog(int level)` - density increases with level
- `EnableGhosts()`, `TriggerPortal()`

#### 3.4 Create Script: PostFXController.cs
**Location:** `Assets/Scripts/AudioVFX/PostFXController.cs`
- Reference URP Volume component
- Access overrides: Vignette, ColorAdjustments, LensDistortion, ChromaticAberration
- `SetLevel(int level)`:
  - Vignette: 0.1 → 0.6
  - Saturation: -50 → -100
  - Chromatic: Active at level 3+
  - Lens Distortion: Active at level 4+

---

### Phase 4: Interactables (M8)

#### 4.1 Create Script: InteractableSpirit.cs
**Location:** `Assets/Scripts/Props/InteractableSpirit.cs`
- Implements `IInteractable`
- Public fields: `spiritKey`, `spookIncrement`, `voiceClip`
- `OnInteract()`: Call LLMManager.SummonSpirit(), EventManager.IncrementSpook()

#### 4.2 Configure Prop Prefabs
| Prop | Spirit | Trigger | Spook Increment |
|------|--------|---------|-----------------|
| CrystalBall | Raven | Look + E | +1 |
| Mirror | Narrator | Look + E | +1 |
| Booth | Usher | Enter zone | +1 |
| Table | Random | Sit | +1 |

---

### Phase 5: Advanced LLM Features (M11, M14, M16)

#### 5.1 Create Script: LLMStreamManager.cs
**Location:** `Assets/Scripts/AI/LLMStreamManager.cs`
- Singleton pattern
- `StreamSpiritSpeech(string prompt)` coroutine
- Stream chunks to UIChat.AppendPartial()
- Trigger AudioManager.StreamWhisper() per chunk
- Parse emotion and call RitualLoop.ReactToEmotion()

#### 5.2 Create Script: EmotionParser.cs
**Location:** `Assets/Scripts/AI/EmotionParser.cs`
- Static class with `Detect(string text)` method
- Regex patterns:
  - "terror" → (terror|fear|dread|heart|mad)
  - "unease" → (sad|lament|mourn|decay|nevermore)
  - "neutral" → default

#### 5.3 Create Script: SpiritMemory.cs
**Location:** `Assets/Scripts/AI/SpiritMemory.cs`
- Serializable class with spiritName, lastPrompts[], lastResponses[]
- `Save(SpiritMemory mem)` - JSON to persistentDataPath
- `Load(string name)` - JSON from persistentDataPath
- Load before chat, append after response, save on quit

---

### Phase 6: System Coordinator (M17)

#### 6.1 Create Script: RitualLoop.cs
**Location:** `Assets/Scripts/Core/RitualLoop.cs`
- Singleton pattern
- `Update()`: Sync PostFX, VFX, Audio with current spookLevel
- `ReactToEmotion(string emotion)`: Adjust PortalDistort shader
- Optional: Fixed timestep (0.5s) for performance

---

### Phase 7: Portal & Finale Scene (M18-M24)

#### 7.1 Create Script: PortalSequence.cs
**Location:** `Assets/Scripts/Core/PortalSequence.cs`
- Singleton pattern
- `StartTransition()` triggers Breach() coroutine
- Fade canvas alpha, increase fog density
- Play breach SFX
- Load "OtherDimension" scene after duration (6s)

#### 7.2 Create Scene: OtherDimension.unity
**Scene Hierarchy:**
```
OtherDimension (Empty Root)
├── PlayerRig (Spawn @ 0, 1.8, 0)
├── Platform (8x8m plane, cracked marble)
├── SpiritCore (Glowing sphere @ 0, 3, 2)
│   └── DimensionalLight component
│   └── EpilogueNarrator component
├── Environment
│   ├── Mist particles
│   └── Skybox (purple-red gradient)
├── Managers (DontDestroyOnLoad from previous scene)
└── UIEpilogue (Canvas for typewriter text)
```

#### 7.3 Create Script: EpilogueNarrator.cs
**Location:** `Assets/Scripts/AI/EpilogueNarrator.cs`
- On Start(): Load SpiritMemory, build farewell prompt
- Request LLM to compose poetic epilogue
- Display via UIEpilogue typewriter effect

#### 7.4 Create Script: DimensionalLight.cs
**Location:** `Assets/Scripts/AudioVFX/DimensionalLight.cs`
- Pulsing light intensity (sine wave)
- Color lerp between magenta and cyan

#### 7.5 Create Script: UIEpilogue.cs
**Location:** `Assets/Scripts/UI/UIEpilogue.cs`
- Typewriter effect coroutine
- Show "[E] to Awaken" after text completes
- On E press: Fade out, save memory, quit application

---

### Phase 8: Debug & Automation (M10, M25)

#### 8.1 Create Script: SpookLevelDebugUI.cs
**Location:** `Assets/Scripts/UI/SpookLevelDebugUI.cs`
- Slider to manually set spook level
- Debug text overlay showing: Spook level, Active spirit, Emotion, Fog density

#### 8.2 Create Script: DebugHotkeys.cs
**Location:** `Assets/Scripts/UI/DebugHotkeys.cs`
- F1 = Reset spook level
- F2 = Summon random spirit
- F3 = Toggle chat UI
- F4 = Skip to portal (debug only)

#### 8.3 Create Editor Script: PrefabBuilder.cs
**Location:** `Assets/Scripts/Editor/PrefabBuilder.cs`
- Menu item: CursedPortal → Build Prefabs
- Generate Managers prefab with all manager components
- Generate prop prefabs with InteractableSpirit components

#### 8.4 Create Editor Script: SceneWiringTool.cs
**Location:** `Assets/Scripts/Editor/SceneWiringTool.cs`
- Menu item: CursedPortal → Wire Scene Objects
- Auto-link singleton references (if needed)

#### 8.5 Create Build Manifest: cursed_portal_build.yaml
**Location:** `Assets/cursed_portal_build.yaml`
- Define project metadata, dependencies, scenes, prefabs
- Automation steps for batch builds

---

## Critical Implementation Rules

### 1. Singleton Pattern
All managers must use singleton pattern with `DontDestroyOnLoad`:
```csharp
public static ClassName Instance;
void Awake() {
    if (Instance == null) {
        Instance = this;
        DontDestroyOnLoad(gameObject);
    } else {
        Destroy(gameObject);
    }
}
```

### 2. File Annotation
Every generated script must include header:
```csharp
// Auto-generated by CursedPortal AI Spec v1.0
// Source: Module M##
```

### 3. One Class Per File
Maintain strict separation - no multiple classes in single file.

### 4. Path Usage
Never hardcode paths. Always use:
- `Application.streamingAssetsPath` for data files
- `Application.persistentDataPath` for save data
- `Resources.Load<T>()` for runtime assets

### 5. Performance Constraints
- URP Forward Rendering, MSAA 2x
- Particle count < 1000 (WebGL compatibility)
- AudioSources ≤ 10 simultaneous
- Whisper clips: Mono, 44.1kHz, max 15s

### 6. Input Mapping
| Key | Action |
|-----|--------|
| WASD | Movement |
| Mouse | Look |
| E | Interact |
| ESC | Toggle Chat UI |
| F1 | Debug: Reset spook |
| F2 | Debug: Random spirit |
| F3 | Debug: Toggle UI |

---

## Module Dependency Order

Generate code in this exact sequence:

```
M1  → Core Setup (Scene, Camera, Lighting)
M2  → Interaction Framework (IInteractable, InteractionManager)
M3  → LLM Manager
M4  → Event Manager (Spook Logic)
M5  → Audio + VFX System
M6  → Post-Processing Stack
M7  → UI Chat System
M8  → Interactables (Props)
M9  → Narrative Profiles (JSON)
M10 → Testing & Debug Tools
M11 → LLM Streaming
M12 → Voice Synthesis (Optional)
M13 → Portal Distortion Shader
M14 → Emotion Parser
M15 → Procedural Ambient (Optional)
M16 → Spirit Memory Persistence
M17 → Ritual Loop (Coordinator)
M18 → OtherDimension Scene
M19 → Portal Transition
M20 → Ethereal Shader (Optional)
M21 → Epilogue Narrator
M22 → Dynamic Audio (Optional)
M23 → Dimensional Light
M24 → Player Conclusion Logic
M25 → Automation Manifest
```

---

## Success Verification Checklist

- [ ] Player spawns and can move with WASD/Mouse
- [ ] E key interacts with props (raycast detection)
- [ ] Chat UI toggles with ESC
- [ ] LLM responds in Poe-style prose
- [ ] Spook level increments on interaction (0→5)
- [ ] Fog, audio, and post-processing change per level
- [ ] Level 5 triggers portal transition
- [ ] OtherDimension scene loads correctly
- [ ] Epilogue displays with typewriter effect
- [ ] Memory persists between sessions
- [ ] Debug tools functional (F1-F3)
- [ ] Build completes without errors
- [ ] Scene loads in < 5 seconds

---

## Narrative Guidelines

### Spirit Tone Reference
| Spirit | Keywords | Style |
|--------|----------|-------|
| Raven | Obsession, refrain, despair | Rhythmic, repetitive "Nevermore" |
| Narrator | Guilt, heartbeat, madness | Frantic justification, paranoid |
| Usher | Decay, confinement, bloodline | Melancholic, poetic dread |

### Example Dialogue
```
"You listen still — to the heart you swore was silent."
"Nevermore shall the light touch these halls..."
"The house... it breathes with me... and dies with me..."
```

### Collective Voice (Finale)
In OtherDimension, all spirits merge into one unified voice using stored memory snippets.

---

## Quick Reference Commands

**Unity Menu:**
- CursedPortal → Build Prefabs
- CursedPortal → Wire Scene Objects

**Runtime Debug:**
- F1: Reset spook to 0
- F2: Summon random spirit
- F3: Toggle debug overlay

**Build:**
```bash
unity -batchmode -nographics -projectPath . -executeMethod PrefabBuilder.BuildAll
unity -batchmode -nographics -buildWindows64Player ./Builds/CursedPortal.exe
```

---

*"Treat every script as a ritual component — modular, self-aware, and written with poetic precision. The system must not merely function; it must whisper, breathe, and remember."*
