// Auto-generated by CursedPortal AI Spec v1.0
// Source: Module M16

using UnityEngine;
using System.IO;
using System.Collections.Generic;

/// <summary>
/// Persists spirit conversation memory across sessions.
/// Stores prompts and responses for each spirit.
/// </summary>
[System.Serializable]
public class SpiritMemory
{
    public string spiritName;
    public string[] lastPrompts;
    public string[] lastResponses;
    public int totalInteractions;
    public string lastInteractionTime;

    // Maximum number of exchanges to store
    private const int MAX_MEMORY_SIZE = 10;

    /// <summary>
    /// Creates a new empty memory for a spirit.
    /// </summary>
    public SpiritMemory()
    {
        lastPrompts = new string[0];
        lastResponses = new string[0];
        totalInteractions = 0;
    }

    /// <summary>
    /// Creates a new memory for a specific spirit.
    /// </summary>
    public SpiritMemory(string name)
    {
        spiritName = name;
        lastPrompts = new string[0];
        lastResponses = new string[0];
        totalInteractions = 0;
    }

    /// <summary>
    /// Adds a new exchange to the memory.
    /// </summary>
    /// <param name="userPrompt">The user's message</param>
    /// <param name="spiritResponse">The spirit's response</param>
    public void AddExchange(string userPrompt, string spiritResponse)
    {
        // Convert to lists for easier manipulation
        List<string> prompts = new List<string>(lastPrompts);
        List<string> responses = new List<string>(lastResponses);

        // Add new exchange
        prompts.Add(userPrompt);
        responses.Add(spiritResponse);

        // Trim to max size (keep most recent)
        while (prompts.Count > MAX_MEMORY_SIZE)
        {
            prompts.RemoveAt(0);
            responses.RemoveAt(0);
        }

        // Update arrays
        lastPrompts = prompts.ToArray();
        lastResponses = responses.ToArray();

        // Update metadata
        totalInteractions++;
        lastInteractionTime = System.DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
    }

    /// <summary>
    /// Gets a summary of recent conversations for context injection.
    /// </summary>
    /// <param name="maxExchanges">Maximum number of exchanges to include</param>
    public string GetContextSummary(int maxExchanges = 3)
    {
        if (lastResponses == null || lastResponses.Length == 0)
        {
            return "";
        }

        int startIndex = Mathf.Max(0, lastResponses.Length - maxExchanges);
        List<string> summaryParts = new List<string>();

        for (int i = startIndex; i < lastResponses.Length; i++)
        {
            if (!string.IsNullOrEmpty(lastResponses[i]))
            {
                // Truncate long responses for context
                string response = lastResponses[i];
                if (response.Length > 100)
                {
                    response = response.Substring(0, 100) + "...";
                }
                summaryParts.Add(response);
            }
        }

        return string.Join(" | ", summaryParts);
    }

    /// <summary>
    /// Clears all memory for this spirit.
    /// </summary>
    public void Clear()
    {
        lastPrompts = new string[0];
        lastResponses = new string[0];
        totalInteractions = 0;
    }

    /// <summary>
    /// Saves a spirit memory to persistent storage.
    /// </summary>
    /// <param name="memory">The memory to save</param>
    public static void Save(SpiritMemory memory)
    {
        if (memory == null || string.IsNullOrEmpty(memory.spiritName))
        {
            Debug.LogWarning("[SpiritMemory] Cannot save: memory or spirit name is null");
            return;
        }

        string path = GetMemoryPath(memory.spiritName);

        try
        {
            // Ensure directory exists
            string directory = Path.GetDirectoryName(path);
            if (!Directory.Exists(directory))
            {
                Directory.CreateDirectory(directory);
            }

            string json = JsonUtility.ToJson(memory, true);
            File.WriteAllText(path, json);

            Debug.Log($"[SpiritMemory] Saved memory for {memory.spiritName} ({memory.totalInteractions} interactions)");
        }
        catch (System.Exception e)
        {
            Debug.LogError($"[SpiritMemory] Failed to save memory: {e.Message}");
        }
    }

    /// <summary>
    /// Loads a spirit memory from persistent storage.
    /// Returns a new empty memory if none exists.
    /// </summary>
    /// <param name="spiritName">The spirit name to load</param>
    public static SpiritMemory Load(string spiritName)
    {
        if (string.IsNullOrEmpty(spiritName))
        {
            Debug.LogWarning("[SpiritMemory] Cannot load: spirit name is null");
            return new SpiritMemory();
        }

        string path = GetMemoryPath(spiritName);

        if (File.Exists(path))
        {
            try
            {
                string json = File.ReadAllText(path);
                SpiritMemory memory = JsonUtility.FromJson<SpiritMemory>(json);

                Debug.Log($"[SpiritMemory] Loaded memory for {spiritName} ({memory.totalInteractions} interactions)");
                return memory;
            }
            catch (System.Exception e)
            {
                Debug.LogError($"[SpiritMemory] Failed to load memory: {e.Message}");
            }
        }

        // Return new empty memory
        Debug.Log($"[SpiritMemory] No existing memory for {spiritName}, creating new");
        return new SpiritMemory(spiritName);
    }

    /// <summary>
    /// Checks if memory exists for a spirit.
    /// </summary>
    public static bool Exists(string spiritName)
    {
        return File.Exists(GetMemoryPath(spiritName));
    }

    /// <summary>
    /// Deletes memory for a spirit.
    /// </summary>
    public static void Delete(string spiritName)
    {
        string path = GetMemoryPath(spiritName);

        if (File.Exists(path))
        {
            File.Delete(path);
            Debug.Log($"[SpiritMemory] Deleted memory for {spiritName}");
        }
    }

    /// <summary>
    /// Gets the file path for a spirit's memory.
    /// </summary>
    private static string GetMemoryPath(string spiritName)
    {
        return Path.Combine(Application.persistentDataPath, "SpiritMemory", $"{spiritName}_memory.json");
    }

    /// <summary>
    /// Gets all saved spirit names.
    /// </summary>
    public static string[] GetAllSavedSpirits()
    {
        string directory = Path.Combine(Application.persistentDataPath, "SpiritMemory");

        if (!Directory.Exists(directory))
        {
            return new string[0];
        }

        string[] files = Directory.GetFiles(directory, "*_memory.json");
        List<string> spirits = new List<string>();

        foreach (string file in files)
        {
            string name = Path.GetFileNameWithoutExtension(file).Replace("_memory", "");
            spirits.Add(name);
        }

        return spirits.ToArray();
    }
}
