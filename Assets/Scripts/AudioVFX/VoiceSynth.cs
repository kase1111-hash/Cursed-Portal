// Auto-generated by CursedPortal AI Spec v1.0
// Source: Module M12

using UnityEngine;

/// <summary>
/// Voice synthesis placeholder for TTS integration.
/// Can be extended to use Piper, Bark, or ElevenLabs APIs.
/// </summary>
public class VoiceSynth : MonoBehaviour
{
    public static VoiceSynth Instance { get; private set; }

    [Header("Audio")]
    [SerializeField] private AudioSource voiceSource;

    [Header("Fallback Clips")]
    [SerializeField] private AudioClip[] whisperClips; // Generic whisper sounds

    [Header("Voice Settings")]
    [SerializeField] private float basePitch = 1f;
    [SerializeField] private float pitchVariation = 0.2f;
    [SerializeField] private float panVariation = 0.1f;
    [SerializeField] private float volume = 0.5f;

    [Header("TTS Settings (Future)")]
    [SerializeField] private string ttsEndpoint = "";
    [SerializeField] private bool useTTS = false;

    // Rate limiting
    private float lastSpeakTime = 0f;
    private float speakCooldown = 0.5f;

    private void Awake()
    {
        // Singleton pattern
        if (Instance == null)
        {
            Instance = this;
        }
        else
        {
            Destroy(gameObject);
            return;
        }
    }

    private void Start()
    {
        // Create AudioSource if not assigned
        if (voiceSource == null)
        {
            voiceSource = gameObject.AddComponent<AudioSource>();
            voiceSource.playOnAwake = false;
            voiceSource.spatialBlend = 0f;
            voiceSource.volume = volume;
        }
    }

    /// <summary>
    /// Speaks the given text using TTS or fallback whisper.
    /// </summary>
    /// <param name="text">Text to speak</param>
    public void Speak(string text)
    {
        // Rate limiting
        if (Time.time - lastSpeakTime < speakCooldown)
        {
            return;
        }
        lastSpeakTime = Time.time;

        if (useTTS && !string.IsNullOrEmpty(ttsEndpoint))
        {
            // Future TTS integration
            StartCoroutine(SpeakTTS(text));
        }
        else
        {
            // Fallback to whisper clips
            PlayWhisperFallback();
        }
    }

    /// <summary>
    /// Plays a fallback whisper sound.
    /// </summary>
    private void PlayWhisperFallback()
    {
        if (voiceSource == null || whisperClips == null || whisperClips.Length == 0)
        {
            return;
        }

        // Select random clip
        AudioClip clip = whisperClips[Random.Range(0, whisperClips.Length)];
        if (clip == null) return;

        // Apply variation
        voiceSource.pitch = basePitch + Random.Range(-pitchVariation, pitchVariation);
        voiceSource.panStereo = Random.Range(-panVariation, panVariation);
        voiceSource.volume = volume * Random.Range(0.8f, 1.2f);

        voiceSource.PlayOneShot(clip);
    }

    /// <summary>
    /// Speaks using external TTS service (placeholder).
    /// </summary>
    private System.Collections.IEnumerator SpeakTTS(string text)
    {
        // Placeholder for TTS API integration
        // Example services:
        // - Piper (local): https://github.com/rhasspy/piper
        // - Bark (local): https://github.com/suno-ai/bark
        // - ElevenLabs (cloud): https://elevenlabs.io/

        Debug.Log($"[VoiceSynth] TTS not implemented. Text: {text.Substring(0, Mathf.Min(50, text.Length))}...");

        // Fallback to whisper
        PlayWhisperFallback();

        yield return null;
    }

    /// <summary>
    /// Sets the voice pitch for emotion-based modulation.
    /// </summary>
    /// <param name="emotion">Detected emotion</param>
    public void SetEmotionPitch(string emotion)
    {
        switch (emotion)
        {
            case EmotionParser.TERROR:
                basePitch = 0.8f; // Lower, more ominous
                pitchVariation = 0.3f;
                break;

            case EmotionParser.UNEASE:
                basePitch = 0.9f;
                pitchVariation = 0.2f;
                break;

            default:
                basePitch = 1f;
                pitchVariation = 0.15f;
                break;
        }
    }

    /// <summary>
    /// Stops any currently playing voice.
    /// </summary>
    public void Stop()
    {
        if (voiceSource != null)
        {
            voiceSource.Stop();
        }
    }

    /// <summary>
    /// Checks if voice is currently playing.
    /// </summary>
    public bool IsPlaying()
    {
        return voiceSource != null && voiceSource.isPlaying;
    }
}
