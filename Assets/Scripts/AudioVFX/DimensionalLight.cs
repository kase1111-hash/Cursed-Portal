// Auto-generated by CursedPortal AI Spec v1.0
// Source: Module M23

using UnityEngine;

/// <summary>
/// Procedural lighting effect for the OtherDimension scene.
/// Creates a pulsing, color-shifting light on the SpiritCore.
/// </summary>
public class DimensionalLight : MonoBehaviour
{
    [Header("Light Reference")]
    [SerializeField] private Light targetLight;

    [Header("Intensity Settings")]
    [SerializeField] private float baseIntensity = 1f;
    [SerializeField] private float pulseAmplitude = 0.5f;
    [SerializeField] private float pulseSpeed = 0.3f;

    [Header("Color Settings")]
    [SerializeField] private Color colorA = Color.magenta;
    [SerializeField] private Color colorB = Color.cyan;
    [SerializeField] private float colorSpeed = 0.5f;

    [Header("Range Settings")]
    [SerializeField] private float baseRange = 10f;
    [SerializeField] private float rangeVariation = 2f;
    [SerializeField] private float rangeSpeed = 0.2f;

    [Header("Flicker")]
    [SerializeField] private bool enableFlicker = true;
    [SerializeField] private float flickerChance = 0.02f;
    [SerializeField] private float flickerIntensity = 0.3f;

    // State
    private float flickerTimer = 0f;
    private bool isFlickering = false;
    private float intensityMultiplier = 1f;

    private void Start()
    {
        // Get Light component if not assigned
        if (targetLight == null)
        {
            targetLight = GetComponent<Light>();
        }

        if (targetLight == null)
        {
            Debug.LogError("[DimensionalLight] No Light component found!");
            return;
        }

        // Initialize light
        targetLight.intensity = baseIntensity;
        targetLight.range = baseRange;
        targetLight.color = colorA;
    }

    private void Update()
    {
        if (targetLight == null) return;

        UpdateIntensity();
        UpdateColor();
        UpdateRange();
        UpdateFlicker();
    }

    /// <summary>
    /// Updates the light intensity with sine wave pulse.
    /// </summary>
    private void UpdateIntensity()
    {
        float pulse = Mathf.Sin(Time.time * pulseSpeed) * pulseAmplitude;
        float intensity = (baseIntensity + pulse) * intensityMultiplier;

        // Apply flicker
        if (isFlickering)
        {
            intensity *= Random.Range(1f - flickerIntensity, 1f);
        }

        targetLight.intensity = intensity;
    }

    /// <summary>
    /// Sets an intensity multiplier for dynamic effects.
    /// </summary>
    public void SetIntensityMultiplier(float multiplier)
    {
        intensityMultiplier = Mathf.Max(0f, multiplier);
    }

    /// <summary>
    /// Gets the current intensity multiplier.
    /// </summary>
    public float GetIntensityMultiplier()
    {
        return intensityMultiplier;
    }

    /// <summary>
    /// Updates the light color with smooth lerp.
    /// </summary>
    private void UpdateColor()
    {
        float t = (Mathf.Sin(Time.time * colorSpeed) + 1f) / 2f;
        targetLight.color = Color.Lerp(colorA, colorB, t);
    }

    /// <summary>
    /// Updates the light range with subtle variation.
    /// </summary>
    private void UpdateRange()
    {
        float variation = Mathf.Sin(Time.time * rangeSpeed) * rangeVariation;
        targetLight.range = baseRange + variation;
    }

    /// <summary>
    /// Handles random flicker effect.
    /// </summary>
    private void UpdateFlicker()
    {
        if (!enableFlicker) return;

        if (isFlickering)
        {
            flickerTimer -= Time.deltaTime;
            if (flickerTimer <= 0f)
            {
                isFlickering = false;
            }
        }
        else
        {
            // Random chance to start flickering
            if (Random.value < flickerChance)
            {
                isFlickering = true;
                flickerTimer = Random.Range(0.1f, 0.3f);
            }
        }
    }

    /// <summary>
    /// Sets the light colors based on emotion.
    /// </summary>
    /// <param name="emotion">Detected emotion</param>
    public void SetEmotion(string emotion)
    {
        switch (emotion)
        {
            case EmotionParser.TERROR:
                colorA = new Color(1f, 0f, 0f); // Red
                colorB = new Color(0.5f, 0f, 0.5f); // Purple
                pulseSpeed = 0.5f;
                break;

            case EmotionParser.UNEASE:
                colorA = new Color(0.5f, 0f, 1f); // Purple
                colorB = new Color(0f, 0.5f, 1f); // Blue
                pulseSpeed = 0.3f;
                break;

            default:
                colorA = Color.magenta;
                colorB = Color.cyan;
                pulseSpeed = 0.3f;
                break;
        }
    }

    /// <summary>
    /// Triggers a bright flash.
    /// </summary>
    public void Flash(float duration = 0.2f)
    {
        StartCoroutine(FlashCoroutine(duration));
    }

    private System.Collections.IEnumerator FlashCoroutine(float duration)
    {
        float originalIntensity = baseIntensity;
        baseIntensity = originalIntensity * 3f;

        yield return new WaitForSeconds(duration);

        baseIntensity = originalIntensity;
    }

    /// <summary>
    /// Fades the light out over duration.
    /// </summary>
    public void FadeOut(float duration)
    {
        StartCoroutine(FadeOutCoroutine(duration));
    }

    private System.Collections.IEnumerator FadeOutCoroutine(float duration)
    {
        float startIntensity = baseIntensity;
        float elapsed = 0f;

        while (elapsed < duration)
        {
            elapsed += Time.deltaTime;
            baseIntensity = Mathf.Lerp(startIntensity, 0f, elapsed / duration);
            yield return null;
        }

        baseIntensity = 0f;
        targetLight.enabled = false;
    }
}
