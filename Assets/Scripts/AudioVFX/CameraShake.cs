// Auto-generated by CursedPortal AI Spec v1.0
// Source: Module M4 - Spook Effects

using UnityEngine;

/// <summary>
/// Advanced camera shake system with multiple shake types.
/// Integrates with EventManager for spook-level-based shaking.
/// </summary>
public class CameraShake : SceneSingletonBase<CameraShake>
{
    [Header("Shake Settings")]
    [SerializeField] private float traumaDecay = 1.3f;
    [SerializeField] private float maxAngle = 10f;
    [SerializeField] private float maxOffset = 0.5f;
    [SerializeField] private float frequency = 25f;

    [Header("Spook Level Shake")]
    [SerializeField] private float[] shakeIntensityByLevel = { 0f, 0.1f, 0.2f, 0.4f, 0.6f, 1f };

    // Trauma value (0-1) - squared for shake intensity
    private float trauma = 0f;
    private float seed;

    // Original transform values
    private Vector3 originalPosition;
    private Quaternion originalRotation;

    protected override void Awake()
    {
        base.Awake();
        if (Instance == this)
        {
            seed = Random.value * 1000f;
        }
    }

    private void Start()
    {
        originalPosition = transform.localPosition;
        originalRotation = transform.localRotation;

        // Subscribe to spook events
        if (EventManager.Instance != null)
        {
            EventManager.Instance.OnSpookLevelChanged += OnSpookLevelChanged;
        }
    }

    private void Update()
    {
        // Decay trauma over time
        if (trauma > 0)
        {
            trauma -= traumaDecay * Time.deltaTime;
            trauma = Mathf.Clamp01(trauma);
        }

        // Apply shake
        if (trauma > 0)
        {
            ApplyShake();
        }
        else
        {
            // Reset to original
            transform.localPosition = originalPosition;
            transform.localRotation = originalRotation;
        }
    }

    /// <summary>
    /// Applies perlin noise-based shake.
    /// </summary>
    private void ApplyShake()
    {
        float shake = trauma * trauma; // Square for more dramatic falloff
        float time = Time.time * frequency;

        // Rotational shake
        float angleX = maxAngle * shake * (Mathf.PerlinNoise(seed, time) * 2f - 1f);
        float angleY = maxAngle * shake * (Mathf.PerlinNoise(seed + 1, time) * 2f - 1f);
        float angleZ = maxAngle * shake * (Mathf.PerlinNoise(seed + 2, time) * 2f - 1f) * 0.5f;

        // Positional shake
        float offsetX = maxOffset * shake * (Mathf.PerlinNoise(seed + 3, time) * 2f - 1f);
        float offsetY = maxOffset * shake * (Mathf.PerlinNoise(seed + 4, time) * 2f - 1f);

        // Apply
        transform.localRotation = originalRotation * Quaternion.Euler(angleX, angleY, angleZ);
        transform.localPosition = originalPosition + new Vector3(offsetX, offsetY, 0f);
    }

    /// <summary>
    /// Adds trauma to trigger shake.
    /// </summary>
    /// <param name="amount">Trauma amount (0-1)</param>
    public void AddTrauma(float amount)
    {
        trauma = Mathf.Clamp01(trauma + amount);
        Debug.Log($"[CameraShake] Trauma added: {amount}, Total: {trauma}");
    }

    /// <summary>
    /// Triggers a one-shot shake.
    /// </summary>
    /// <param name="intensity">Shake intensity (0-1)</param>
    /// <param name="duration">How long shake lasts</param>
    public void Shake(float intensity, float duration = 0.5f)
    {
        AddTrauma(intensity);
        // Adjust decay so it lasts approximately the duration
        traumaDecay = intensity / duration;
    }

    /// <summary>
    /// Called when spook level changes.
    /// </summary>
    private void OnSpookLevelChanged(int level)
    {
        if (level < shakeIntensityByLevel.Length && level > 0)
        {
            float intensity = shakeIntensityByLevel[level];
            if (intensity > 0)
            {
                Shake(intensity, 0.5f + level * 0.2f);
            }
        }
    }

    /// <summary>
    /// Triggers continuous low shake for ambient unease.
    /// </summary>
    public void SetAmbientShake(float intensity)
    {
        trauma = Mathf.Max(trauma, intensity * 0.3f);
    }

    /// <summary>
    /// Stops all shake immediately.
    /// </summary>
    public void StopShake()
    {
        trauma = 0f;
        transform.localPosition = originalPosition;
        transform.localRotation = originalRotation;
    }

    protected override void OnDestroy()
    {
        if (EventManager.Instance != null)
        {
            EventManager.Instance.OnSpookLevelChanged -= OnSpookLevelChanged;
        }
        base.OnDestroy();
    }
}
