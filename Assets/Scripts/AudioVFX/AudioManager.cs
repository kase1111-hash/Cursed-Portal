// Auto-generated by CursedPortal AI Spec v1.0
// Source: Module M5

using UnityEngine;

/// <summary>
/// Manages all audio in the Cursed Portal including ambient sounds,
/// whispers, sound effects, and voice synthesis integration.
/// </summary>
public class AudioManager : MonoBehaviour
{
    public static AudioManager Instance { get; private set; }

    [Header("Audio Sources")]
    [SerializeField] private AudioSource ambientSource;
    [SerializeField] private AudioSource sfxSource;
    [SerializeField] private AudioSource voiceSource;
    [SerializeField] private AudioSource whisperSource;

    [Header("Whisper Clips (by spook level 0-5)")]
    [SerializeField] private AudioClip[] whisperClips;

    [Header("Sound Effects")]
    [SerializeField] private AudioClip heartbeatClip;
    [SerializeField] private AudioClip mirrorCrackClip;
    [SerializeField] private AudioClip portalBreachClip;
    [SerializeField] private AudioClip interactClip;

    [Header("Ambient Settings")]
    [SerializeField] private float baseAmbientVolume = 0.3f;
    [SerializeField] private float baseAmbientPitch = 0.8f;
    [SerializeField] private float volumePerLevel = 0.1f;
    [SerializeField] private float pitchPerLevel = 0.04f;

    // Current state
    private int currentWhisperLevel = 0;

    private void Awake()
    {
        // Singleton pattern with persistence
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject);
        }
        else
        {
            Destroy(gameObject);
            return;
        }
    }

    private void Start()
    {
        // Initialize audio sources if not assigned
        if (ambientSource == null)
        {
            ambientSource = CreateAudioSource("AmbientSource", true);
        }
        if (sfxSource == null)
        {
            sfxSource = CreateAudioSource("SFXSource", false);
        }
        if (voiceSource == null)
        {
            voiceSource = CreateAudioSource("VoiceSource", false);
        }
        if (whisperSource == null)
        {
            whisperSource = CreateAudioSource("WhisperSource", true);
        }

        // Start baseline ambience
        PlayWhispers(0);
    }

    /// <summary>
    /// Creates an AudioSource component with specified settings.
    /// </summary>
    private AudioSource CreateAudioSource(string name, bool loop)
    {
        GameObject sourceObj = new GameObject(name);
        sourceObj.transform.SetParent(transform);
        AudioSource source = sourceObj.AddComponent<AudioSource>();
        source.loop = loop;
        source.playOnAwake = false;
        source.spatialBlend = 0f; // 2D sound
        return source;
    }

    /// <summary>
    /// Plays whisper ambience for the given spook level.
    /// </summary>
    /// <param name="level">Spook level (0-5)</param>
    public void PlayWhispers(int level)
    {
        if (whisperClips == null || level >= whisperClips.Length)
        {
            Debug.LogWarning($"[AudioManager] No whisper clip for level {level}");
            return;
        }

        if (whisperClips[level] == null)
        {
            Debug.LogWarning($"[AudioManager] Whisper clip at level {level} is null");
            return;
        }

        currentWhisperLevel = level;
        whisperSource.clip = whisperClips[level];
        whisperSource.volume = baseAmbientVolume + (level * volumePerLevel);
        whisperSource.pitch = baseAmbientPitch + (level * pitchPerLevel);

        if (!whisperSource.isPlaying)
        {
            whisperSource.Play();
        }

        Debug.Log($"[AudioManager] Playing whispers at level {level}");
    }

    /// <summary>
    /// Updates ambient audio parameters based on spook level.
    /// </summary>
    /// <param name="level">Spook level (0-5)</param>
    public void UpdateAmbience(int level)
    {
        if (whisperSource != null)
        {
            whisperSource.volume = baseAmbientVolume + (level * volumePerLevel);
            whisperSource.pitch = baseAmbientPitch + (level * pitchPerLevel);
        }

        if (ambientSource != null)
        {
            ambientSource.volume = 0.2f + (level * 0.05f);
        }
    }

    /// <summary>
    /// Plays a one-shot sound effect.
    /// </summary>
    /// <param name="clip">The audio clip to play</param>
    /// <param name="pitch">Optional pitch modifier (default 1.0)</param>
    public void PlaySFX(AudioClip clip, float pitch = 1f)
    {
        if (clip == null || sfxSource == null) return;

        sfxSource.pitch = pitch + Random.Range(-0.1f, 0.1f); // Slight variation
        sfxSource.PlayOneShot(clip);
    }

    /// <summary>
    /// Plays the heartbeat sound effect.
    /// </summary>
    public void PlayHeartbeat()
    {
        PlaySFX(heartbeatClip, 1f);
    }

    /// <summary>
    /// Plays the mirror crack sound effect.
    /// </summary>
    public void PlayMirrorCrack()
    {
        PlaySFX(mirrorCrackClip, 0.9f);
    }

    /// <summary>
    /// Plays the portal breach sound effect.
    /// </summary>
    public void PlayPortalBreach()
    {
        PlaySFX(portalBreachClip, 1f);
    }

    /// <summary>
    /// Plays the interaction sound effect.
    /// </summary>
    public void PlayInteract()
    {
        PlaySFX(interactClip, 1f);
    }

    /// <summary>
    /// Streams a whisper based on LLM chunk (for real-time feedback).
    /// Called by VoiceSynth or LLMStreamManager.
    /// </summary>
    /// <param name="chunk">Text chunk from LLM response</param>
    public void StreamWhisper(string chunk)
    {
        // Trigger a brief whisper burst for each chunk
        if (voiceSource != null && whisperClips != null && whisperClips.Length > 0)
        {
            // Play a short whisper clip with randomized pitch
            int clipIndex = Mathf.Min(currentWhisperLevel, whisperClips.Length - 1);
            if (whisperClips[clipIndex] != null)
            {
                voiceSource.pitch = Random.Range(0.8f, 1.2f);
                voiceSource.panStereo = Random.Range(-0.2f, 0.2f); // Spatial movement
                voiceSource.PlayOneShot(whisperClips[clipIndex], 0.3f);
            }
        }

        // Integrate with VoiceSynth if available
        if (VoiceSynth.Instance != null)
        {
            VoiceSynth.Instance.Speak(chunk);
        }
    }

    /// <summary>
    /// Fades out all audio over duration.
    /// </summary>
    /// <param name="duration">Fade duration in seconds</param>
    public void FadeOutAll(float duration)
    {
        StartCoroutine(FadeOutCoroutine(duration));
    }

    private System.Collections.IEnumerator FadeOutCoroutine(float duration)
    {
        float startVolume = whisperSource.volume;
        float elapsed = 0f;

        while (elapsed < duration)
        {
            elapsed += Time.deltaTime;
            float t = elapsed / duration;

            if (whisperSource != null)
                whisperSource.volume = Mathf.Lerp(startVolume, 0f, t);
            if (ambientSource != null)
                ambientSource.volume = Mathf.Lerp(ambientSource.volume, 0f, t);

            yield return null;
        }
    }

    /// <summary>
    /// Stops all audio immediately.
    /// </summary>
    public void StopAll()
    {
        if (ambientSource != null) ambientSource.Stop();
        if (sfxSource != null) sfxSource.Stop();
        if (voiceSource != null) voiceSource.Stop();
        if (whisperSource != null) whisperSource.Stop();
    }
}
