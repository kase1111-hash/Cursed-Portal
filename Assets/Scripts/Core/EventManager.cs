// Auto-generated by CursedPortal AI Spec v1.0
// Source: Module M4

using UnityEngine;
using System;

/// <summary>
/// Manages the spook escalation system and coordinates horror effects.
/// Central hub for triggering audio, visual, and atmospheric changes.
/// </summary>
public class EventManager : SingletonBase<EventManager>
{
    [Header("Spook Settings")]
    [SerializeField] private int maxSpookLevel = 5;

    // Current spook level (0-5)
    public int SpookLevel { get; private set; } = 0;

    // Events for other systems to subscribe to
    public event Action<int> OnSpookLevelChanged;
    public event Action<string> OnEmotionDetected;
    public event Action OnDimensionBreach;

    // Debounce tracking - each level triggers effects only once
    private bool[] levelTriggered;

    protected override void Awake()
    {
        base.Awake();
        if (Instance == this)
        {
            levelTriggered = new bool[maxSpookLevel + 1];
        }
    }

    private void Start()
    {
        // Apply initial baseline effects
        ApplyEffectsForLevel(0);
    }

    /// <summary>
    /// Increments the spook level by the specified amount.
    /// </summary>
    /// <param name="delta">Amount to increase (default 1)</param>
    public void IncrementSpook(int delta = 1)
    {
        int previousLevel = SpookLevel;
        SpookLevel = Mathf.Clamp(SpookLevel + delta, 0, maxSpookLevel);

        if (SpookLevel != previousLevel)
        {
            Debug.Log($"[EventManager] Spook level increased: {previousLevel} -> {SpookLevel}");
            ApplyEffectsForLevel(SpookLevel);
            OnSpookLevelChanged?.Invoke(SpookLevel);
        }
    }

    /// <summary>
    /// Decrements the spook level by the specified amount.
    /// </summary>
    /// <param name="delta">Amount to decrease (default 1)</param>
    public void DecrementSpook(int delta = 1)
    {
        int previousLevel = SpookLevel;
        SpookLevel = Mathf.Clamp(SpookLevel - delta, 0, maxSpookLevel);

        if (SpookLevel != previousLevel)
        {
            Debug.Log($"[EventManager] Spook level decreased: {previousLevel} -> {SpookLevel}");
            ApplyEffectsForLevel(SpookLevel);
            OnSpookLevelChanged?.Invoke(SpookLevel);
        }
    }

    /// <summary>
    /// Sets the spook level directly (for debug purposes).
    /// </summary>
    /// <param name="level">Target level (0-5)</param>
    public void SetSpookLevel(int level)
    {
        SpookLevel = Mathf.Clamp(level, 0, maxSpookLevel);

        // Reset debounce for all levels above current (with bounds check)
        if (levelTriggered != null)
        {
            for (int i = level + 1; i < levelTriggered.Length && i <= maxSpookLevel; i++)
            {
                levelTriggered[i] = false;
            }
        }

        ApplyEffectsForLevel(SpookLevel);
        OnSpookLevelChanged?.Invoke(SpookLevel);
    }

    /// <summary>
    /// Applies horror effects for the given spook level.
    /// Coordinates with AudioManager, VFXManager, and PostFXController.
    /// </summary>
    /// <param name="level">The spook level (0-5)</param>
    public void ApplyEffectsForLevel(int level)
    {
        // Bounds check for levelTriggered array
        if (levelTriggered == null || level < 0 || level >= levelTriggered.Length)
        {
            Debug.LogWarning($"[EventManager] Invalid level {level} or uninitialized levelTriggered array");
            return;
        }

        // Debounce - only trigger new level effects once
        if (level > 0 && levelTriggered[level])
        {
            return;
        }
        levelTriggered[level] = true;

        Debug.Log($"[EventManager] Applying effects for level {level}");

        // Coordinate with other managers (null checks for safety)
        if (AudioManager.Instance != null)
        {
            AudioManager.Instance.PlayWhispers(level);
            AudioManager.Instance.UpdateAmbience(level);
        }

        if (VFXManager.Instance != null)
        {
            VFXManager.Instance.UpdateFog(level);
        }

        if (PostFXController.Instance != null)
        {
            PostFXController.Instance.SetLevel(level);
        }

        // Level-specific effects
        switch (level)
        {
            case 0:
                // Baseline: faint whispers, minimal fog
                break;
            case 1:
                // Orb glow, slight vignette
                break;
            case 2:
                // Fog thickens, camera shake
                TriggerCameraShake(0.1f, 0.5f);
                break;
            case 3:
                // Loud whispers, phantom silhouettes
                if (VFXManager.Instance != null)
                {
                    VFXManager.Instance.EnableGhosts();
                }
                break;
            case 4:
                // Mirror glitch, lens distortion
                break;
            case 5:
                // DIMENSION BREACH - trigger portal sequence
                Debug.Log("[EventManager] DIMENSION BREACH! Triggering portal...");
                OnDimensionBreach?.Invoke();
                if (PortalSequence.Instance != null)
                {
                    PortalSequence.Instance.StartTransition();
                }
                break;
        }
    }

    /// <summary>
    /// Reacts to detected emotion from LLM responses.
    /// Called by EmotionParser to adjust atmosphere.
    /// </summary>
    /// <param name="emotion">Detected emotion: "terror", "unease", or "neutral"</param>
    public void ReactToEmotion(string emotion)
    {
        Debug.Log($"[EventManager] Emotion detected: {emotion}");
        OnEmotionDetected?.Invoke(emotion);

        switch (emotion)
        {
            case "terror":
                // Increase fog, bass boost
                if (VFXManager.Instance != null)
                {
                    VFXManager.Instance.AddFogBurst(0.02f);
                }
                break;
            case "unease":
                // Cooler color grade
                break;
            case "neutral":
                // Fade whispers slightly
                break;
        }

        // Update portal distortion if available
        if (PortalDistort.Instance != null)
        {
            PortalDistort.Instance.SetEmotion(emotion);
        }
    }

    /// <summary>
    /// Resets the spook level to zero.
    /// </summary>
    public void ResetSpook()
    {
        SpookLevel = 0;
        System.Array.Fill(levelTriggered, false);
        ApplyEffectsForLevel(0);
        OnSpookLevelChanged?.Invoke(0);
        Debug.Log("[EventManager] Spook level reset to 0");
    }

    /// <summary>
    /// Triggers a camera shake effect.
    /// </summary>
    private void TriggerCameraShake(float intensity, float duration)
    {
        if (CameraShake.Instance != null)
        {
            CameraShake.Instance.AddTrauma(intensity);
        }
    }

    /// <summary>
    /// Gets the normalized spook level (0-1 range).
    /// </summary>
    public float GetNormalizedSpookLevel()
    {
        return (float)SpookLevel / maxSpookLevel;
    }

}
