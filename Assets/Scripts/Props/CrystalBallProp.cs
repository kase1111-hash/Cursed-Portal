// Auto-generated by CursedPortal AI Spec v1.0
// Source: Module M8 - Crystal Ball Prop

using UnityEngine;

/// <summary>
/// Crystal Ball prop - summons the Raven spirit.
/// Features glowing orb effect, mist particles, and "Nevermore" audio.
/// </summary>
public class CrystalBallProp : MonoBehaviour, IInteractable
{
    [Header("Spirit Settings")]
    [SerializeField] private string spiritKey = "Raven";
    [SerializeField] private int spookIncrement = 1;

    [Header("Visual Effects")]
    [SerializeField] private Light orbLight;
    [SerializeField] private float baseGlowIntensity = 0.5f;
    [SerializeField] private float activeGlowIntensity = 3f;
    [SerializeField] private Color baseColor = new Color(0.3f, 0.2f, 0.5f);
    [SerializeField] private Color activeColor = new Color(0.6f, 0.3f, 1f);
    [SerializeField] private ParticleSystem mistParticles;
    [SerializeField] private ParticleSystem sparkParticles;

    [Header("Audio")]
    [SerializeField] private AudioSource ambientSource;
    [SerializeField] private AudioClip humClip;
    [SerializeField] private AudioClip activateClip;
    [SerializeField] private AudioClip nevermoreClip;

    [Header("Animation")]
    [SerializeField] private float floatAmplitude = 0.05f;
    [SerializeField] private float floatSpeed = 1f;
    [SerializeField] private float rotationSpeed = 10f;

    // State
    private bool isHighlighted = false;
    private bool isActive = false;
    private Vector3 startPosition;
    private Material orbMaterial;
    private float activationTime = 0f;

    private void Start()
    {
        startPosition = transform.position;

        // Get material for emission control
        Renderer rend = GetComponent<Renderer>();
        if (rend != null)
        {
            orbMaterial = rend.material;
        }

        // Setup light
        if (orbLight == null)
        {
            orbLight = GetComponentInChildren<Light>();
        }
        if (orbLight != null)
        {
            orbLight.intensity = baseGlowIntensity;
            orbLight.color = baseColor;
        }

        // Start ambient hum
        if (ambientSource != null && humClip != null)
        {
            ambientSource.clip = humClip;
            ambientSource.loop = true;
            ambientSource.volume = 0.2f;
            ambientSource.Play();
        }

        // Start mist particles
        if (mistParticles != null)
        {
            mistParticles.Play();
        }
    }

    private void Update()
    {
        AnimateFloat();
        AnimateRotation();
        UpdateGlow();
    }

    /// <summary>
    /// Animates gentle floating motion.
    /// </summary>
    private void AnimateFloat()
    {
        float yOffset = Mathf.Sin(Time.time * floatSpeed) * floatAmplitude;
        transform.position = startPosition + Vector3.up * yOffset;
    }

    /// <summary>
    /// Animates slow rotation.
    /// </summary>
    private void AnimateRotation()
    {
        transform.Rotate(Vector3.up, rotationSpeed * Time.deltaTime);
    }

    /// <summary>
    /// Updates the glow effect based on state.
    /// </summary>
    private void UpdateGlow()
    {
        if (orbLight == null) return;

        float targetIntensity = isHighlighted ? baseGlowIntensity * 2f : baseGlowIntensity;
        Color targetColor = baseColor;

        if (isActive)
        {
            float pulse = 0.5f + Mathf.Sin((Time.time - activationTime) * 5f) * 0.5f;
            targetIntensity = Mathf.Lerp(activeGlowIntensity * 0.5f, activeGlowIntensity, pulse);
            targetColor = Color.Lerp(baseColor, activeColor, pulse);
        }

        orbLight.intensity = Mathf.Lerp(orbLight.intensity, targetIntensity, 5f * Time.deltaTime);
        orbLight.color = Color.Lerp(orbLight.color, targetColor, 5f * Time.deltaTime);

        // Update material emission
        if (orbMaterial != null)
        {
            orbMaterial.SetColor("_EmissionColor", targetColor * targetIntensity * 0.5f);
        }
    }

    public void OnInteract()
    {
        Debug.Log("[CrystalBallProp] Interacted - Summoning Raven");

        // Activate visual effects
        StartCoroutine(ActivationSequence());

        // Summon spirit
        if (LLMManager.Instance != null)
        {
            LLMManager.Instance.SummonSpirit(spiritKey);
        }

        // Increment spook
        if (EventManager.Instance != null)
        {
            EventManager.Instance.IncrementSpook(spookIncrement);
        }

        // Show chat
        if (UIChat.Instance != null && !UIChat.Instance.IsVisible())
        {
            UIChat.Instance.Show();
        }
    }

    /// <summary>
    /// Activation visual sequence.
    /// </summary>
    private System.Collections.IEnumerator ActivationSequence()
    {
        isActive = true;
        activationTime = Time.time;

        // Play activation sound
        if (AudioManager.Instance != null && activateClip != null)
        {
            AudioManager.Instance.PlaySFX(activateClip);
        }

        // Burst of sparks
        if (sparkParticles != null)
        {
            sparkParticles.Emit(30);
        }

        // Increase mist
        if (mistParticles != null)
        {
            var emission = mistParticles.emission;
            emission.rateOverTime = 50f;
        }

        // Camera shake
        if (CameraShake.Instance != null)
        {
            CameraShake.Instance.Shake(0.2f, 0.3f);
        }

        // Wait for buildup
        yield return new WaitForSeconds(1f);

        // Play "Nevermore" clip
        if (AudioManager.Instance != null && nevermoreClip != null)
        {
            AudioManager.Instance.PlaySFX(nevermoreClip);
        }

        // Screen flash
        if (ScreenEffects.Instance != null)
        {
            ScreenEffects.Instance.SpiritFlash();
        }

        yield return new WaitForSeconds(2f);

        // Return to normal
        isActive = false;

        if (mistParticles != null)
        {
            var emission = mistParticles.emission;
            emission.rateOverTime = 10f;
        }
    }

    public void OnHighlightEnter()
    {
        isHighlighted = true;

        // Increase ambient sound
        if (ambientSource != null)
        {
            ambientSource.volume = 0.4f;
        }
    }

    public void OnHighlightExit()
    {
        isHighlighted = false;

        if (ambientSource != null)
        {
            ambientSource.volume = 0.2f;
        }
    }

    private void OnDestroy()
    {
        // Clean up material instance created via .material accessor
        if (orbMaterial != null)
        {
            Object.Destroy(orbMaterial);
        }
    }
}
